<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crozy Road: revelation</title>
    <link rel="stylesheet" href="gameStyles.css">
</head>
<body>

    <canvas id="myCanvas" width="1500" height="880"></canvas>

    <script>
        const c = document.getElementById("myCanvas");
        const ctx = c.getContext("2d");

        const audio = new Audio("mario-coin.mp3");
        const backgroundMusic = new Audio('audio/donkey-kong-country.mp3');
        backgroundMusic.loop = true;
        backgroundMusic.muted = true;

        //Imagenes
        const playerSprite = new Image();
        const carJeepBlue = new Image();
        const carJeepBlack = new Image();
        const carBoxtruckBrown = new Image();
        const musicMuted = new Image();
        const musicNotMuted = new Image();
        playerSprite.src = "img/ChickenWalkALLx2.png";
        carJeepBlue.src = "img/Blue_JEEP_CLEAN_8D_000-sheet.png";
        carJeepBlack.src = "img/Black_JEEP_CLEAN_8D_000-sheet.png";
        carBoxtruckBrown.src = "img/Brown_BOXTRUCK_CLEAN_8D_000-sheet.png";
        musicMuted.src = "img/MusicMuted.png";
        musicNotMuted.src = "img/MusicNotMuted.png";

        const keys = [];
        let juegoTerminado = false;
        let pause = false;
        let direction = "";
        let nivel = 1;
        let enemys = []

        

        class Entidad {
            constructor(x,y,w,h,c,s,vida,tipo,frameX,frameY,moving) {
                this.x = x;
                this.y = y;
                this.w = w;
                this.h = h;
                this.c = c;
                this.s = s;
                this.vida = vida;
                this.frameX = frameX;
                this.frameY = frameY;
                this.moving = false;
            }

            estaTocando(objetivo){
                if (this.x < objetivo.x + objetivo.w && 
                    this.x + this.w > objetivo.x   &&
                    this.y < objetivo.y + objetivo.h && 
                    this.y + this.h > objetivo.y) {
                    return true;

                    //Si entidad jugador choca con enemigo pierda una vida de 3
                    if (this.tipo=="player" && objetivo.tipo=="enemy"){
                        this.vida-=1;
                        conVida();
                    }
                }
                return false;
            };

        }

        function reset (){
            player.x=10;
            player.y=420;
            player.frameX=0;
            player.frameY=0;
            player.s=2;
            player.moving=false;


        }
        
        function enemysLevelOne(){
            enemys.length = 0;
            let desplazamiento = 50;
            for(let i=0;i<=5;i++){
                let enemy = new Entidad((250+(desplazamiento*i)),420,44,57,getRandomColor(),4,-1,"enemy",0.65,3.95,true);
                enemys.push(enemy);
            }
        }

        const player = new Entidad(10,420,32,32,getRandomColor(),2,3,"player",0,0,false);
        
        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function drawSprite(img,sX,sY,sW,sH,dX,dY,dW,dH){
            ctx.drawImage(img,sX,sY,sW,sH,dX,dY,dW,dH);
        }

        document.addEventListener('keydown', (e) => {
            keys[e.keyCode] = true;
            player.moving = true;
            if (keys[32]){
                pause = !pause;
            }
            if (keys[77]){
                backgroundMusic.pause();
                backgroundMusic.muted = !backgroundMusic.muted;
                backgroundMusic.play();
            }
            console.log("Código: "+e.keyCode); ///////////////Eliminar al finalizar
        });

        document.addEventListener("keyup", (e) => {
            delete keys[e.keyCode];
            player.moving = false;
        });

        function movePlayer(){
            if (keys[38] && player.y > 0){
                player.y -= player.s;
                player.frameY=1;
            }
            if (keys[40] && player.y < 850){
                player.y += player.s;
                player.frameY=0;
            }
            if (keys[37] && player.x > 0){
                player.x -= player.s;
                player.frameY=2;
            }
            if (keys[39] && player.x < 1470){
                player.x += player.s;
                player.frameY=3;
            }
        }

        function playerAnimation(){
            if (player.frameX < 3 && player.moving) player.frameX++
            else player.frameX = 0;
        }

        enemysLevelOne();

        function update(){
            if (pause){
                //Se detienen los movimientos
            }else {
                movePlayer();

                //Movimiento de los enemigos
                enemys.forEach(enemy => {
                    enemy.y-=enemy.s;
                    if (enemy.y < -20){
                        enemy.y = 900;
                    }
                });
            }
            
            enemys.forEach(enemy => {
                if (player.estaTocando(enemy)) {
                    audio.play();
                    

                    if (player.vida === 1){
                        juegoTerminado=true;
                        console.log("El jugador perdió todas sus vidas");
                    }else{
                        console.log("Vida del jugador: "+(player.vida-1))
                        player.vida-=1;
                        player.x=10;//Reinicia la posicion del jugador
                        player.y=420;//Reinicia la posicion del jugador
                    }
                }
            });
            
        }

        function dibujar(){
            //fondo blanco
            ctx.fillStyle = "white";
            ctx.fillRect(1, 1, 1498, 878);

            //dibujar jugador
            drawSprite(playerSprite, player.w * player.frameX , player.h * player.frameY ,player.w,player.h,player.x,player.y,player.w,player.h);

            //dibujar enemigos
            enemys.forEach(enemy => {
                ctx.strokeStyle = "black";
                ctx.strokeRect(enemy.x,enemy.y,enemy.w,enemy.h);
                drawSprite(carJeepBlue, enemy.w * enemy.frameX , enemy.h * enemy.frameY ,enemy.w,enemy.h,enemy.x,enemy.y,enemy.w,enemy.h);
            });

            if (pause){
                ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                ctx.fillRect(1, 1, 1498, 879);

                ctx.fillStyle = "black";
                ctx.font = "30px Arial";
                ctx.fillText("P A U S A", 725, 350);
            }

            if (backgroundMusic.muted){
                ctx.fillStyle = "black";
                ctx.fillRect(1396,804,93,64);
                ctx.drawImage(musicMuted,0,0,256,167,1400,808,85,56);
            }else{
                ctx.fillStyle = "black";
                ctx.fillRect(1396,804,93,64);
                ctx.drawImage(musicNotMuted,0,0,256,181,1400,808,85,56);
            }

            update();
            requestAnimationFrame(dibujar);
        };
        requestAnimationFrame(dibujar);

        setInterval(function(){
            playerAnimation();
        }, 100)
        
    </script>
</body>
</html>
